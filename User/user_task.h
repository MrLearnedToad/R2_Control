/*
据本人统计，在引入二次元以后，bug出现频率下降了11.4514%
           ..   ...       rX  ji.                                                                   
            .              .:    ..                                                                 
            Y    ......     .7. ...::::.                                                            
            7.   ......:.    .i. .   ..i::                                                          
            .i   .:.......     :.       . :7i                                                       
             7    .:...r:      .::        .. :i                                                     
             i     ::....        .:.       .. 7v::..::iirir:.                                       
             i.     ....           :ri..         .:i:     .::::::.                                  
              7   ....irv7r:       .i:...     .:i:.           .  .:::.                              
              L.    ..:ii7i.     .:7r.       .:.              :.    ..ii     . .                    
              .s      .....:77. .7L:.       UKs:iiriii:i:..    .     :  :v:...is:i                  
               ri   .::iii:rri iYr:.       ZZZJ..:.:.::::iiii:.:.    .v  ..   .. ......  r5viY      
               .v      .:ii:i:r7.:.       gZbU:.:::.........:::ii:.   :J   :...      ...iEQBBM   ...
             ..:      .iiii:i1i.:.      .BD2s1sv7v77rrii::::...:. .:.  v:   ..    .YbvrX2QBq.    .:i
                .LJ:..ii:::r2:.:.   .  .J:   .       :i .:::i::.. :.::::j     .:7IEXv:7QBu  ..:.::r.
               ..:...:... :u:..: .     s.   :        i      .:rri:.:.:.iB: .  :BMBBIPBDB:           
              .iJ  ..... .v::.i .     i:   ::        :        . .ir7r.. Eu  .  rBQBEQBB.            
               :.  .... .r:i.:. :  . .L    7         :        .  . .7U7.7b   .  XBBQBB       :.::iii
       .      7....:.   7i:i.: .. .  ri.  r:  .     .:  .     .  ..   ssPE   .   BB75   .    .i:... 
  ::..::     .:.:X7u  .uri:i.i r     7.. .D. ..  .  ::     . ...  .   . iB.    . 7Rr   :ri..   .... 
.    ..         i77 :rPvrir:i. r  . :r.  JS  ::.. . 1.. .   . .. ..   .  Ii     . 7:i. .rrvr:.:.  . 
     i       .r.7LirrvL:7:iir. r .  Jr. .q7  i. .. .1..  . .  .. :.      :r  .  .  .rrri..:i:       
    i       .v  7:vvrU:rv.:rr .i.  .P:. L.7  s.    :s.. . . . .  :. . :   i     :. .iiirr.....      
   :i       .u.:sis  i:v7.:7r  r   :ui  . .  Y.  . r7..  . .  :  :   .:  ...    .: .r:::ii          
   vi        Ji:r.v::.r2r iri .L.  .vEBBggZJ::: . .r:.: . .. .s .7. ..: .: :    :.: :i .... ... .:r.
  ..         ii:77 :.i15: :vi .I.  7BBusqPXgBM..7.:. :r  . . 77 .S . .: .r i.   :::. L. ..   :u7.   
: .         v.ir:r.: UMr: :rr  sr .gI :BBS21D2i  :i  :1. ... v: ru   :. .7 i.   ri r  7 ....J  .    
 .       .:.X::7.iQ. vSi: .r7  rU  .r Z7i  BB.       ..:. .. :  rr   j  .S :..  rv v. :i .. :       
v.       i ..u.::ii . si: :.Y. .Ii  v r    :P           . .:i1Ji .  :j  :Q .... rL :5  J. .. i      
i       i  ..ur:i   : rL..:.7.  75. .. .....              .BQBBIQD  Ur  rB ...  i5  B. .U.:ii:ri    
        :   irs1rri.:  v:.::.:  .JX. :                   :BB7vuDiBBiD:  SQ .:.  :B. sP  LY          
       ::      ::Ri:   r:: I r.. iJg  .                  Ui. vBB  BUU.  2I:... ..Bi .qi  7          
       L.        Sii   v.: 7:.. . iP1                    .  ..vr  QgY  i7Jr... ..ri  YJ  ri     .7. 
    .. 7:         i1r  1::  v . .. YS                      ..:   .7B:  U.sr: .  i... 1iL .7      r:.
    .L .:         r7vvrP:.  .:   .. g:  .                        :jj  Si ri. .  v  : vi7  i      :  
     i:           :7rL.jr.:  :.   : .B:         .               r1U. Y5 :S.  ...v  i r7vS ri     :. 
.     r            1i..YP i.  :    : 2Zi                       rUi: DB  Z.   ..::  5 :K.g.:i     .J 
r.    ::  .         r   g..:   7   .  IuU                    i7777..2  E7   ...i   B :2 7::r     .7 
 ..   i.             ii .v :i  .u     ::   i             .:rjb  .  .  5K    :...  :g .D.  7:     :. 
  i   i:         ...  .:.K. 2:  i7   .   JZQUvi:::::r....I1i:iiv  .  7D    .. :  s:2 :d   I.    :u  
   :i i:          ...   :vi qQ:  iS  .. QBBBBBBBBQBBBRg   :Irjir7  .rv.   .. :2.S7:Y ur   I   ii.   
   .us::          .   .:  b .BBi  51  : iBBBgQEBBPEbQQBr  .i.:rv: :g::   ... 1vrri:S j. .: i:r.     
     i:.:           .SKIPdQL SgQZ  Yg .  ruPggggBQDgBBBb      rLrrLj:   :.Y  qrii:YQr.    .J.       
      r...   ..    .DQgMEPKB. QBBB..BBi .Y:   .JQBBBBBg    .:j .2:g7  .: vi .Qir::5v.             ..
      :: ....     7bBEqSBPPBBiEBEi:.:QB .sP:iPBQBBYIBB      Yu  : 7  :. 7E  ui  .:                ..
. ..  72...  . ..BBBBQMbZQQBBYi:      i .5.s:rr:   i7.    . BU i    i.:IrZ .S  :                  .i
. .:. :vv7r:i: :EBDgQRRQBBK    7:     . :riIu.    7:v    rB YB:Bi :i:7Y .. L: r       .           ir
. .... Lrrr7i::BBPSREDQBB7      .. .. :.i  JM5   .dBPjvSvv5ZDBQBP:::    r :i L.  .  ..          .7ui
:..... vvrriri.DBQRBBBBB    ......... Si. .:DBBBBB5BBQgS7..:ii7:. .i:. :..rr7   ..... .  ..   .:vv7.
i::. ..s2:rrriJi 75BQBBK ........... 7v   XUuu:sY K2    ..:i::.:..    rLiS5r:.. .....:.... .iviiri:.
7:iv777:Yi:iisr       1. .............   jU rrP1M i:                 i1r.  u5: .:iiri......ir:irriri
ri7X     7v7sr       :7  .............  LBRBERBu:                  :vj.   rQdU..:77:   .:...rv7vv77r
7:7ru.    gQ2        Y: .............. iBBBZKQP:                 rUi.:   v. .7rj2: .:ir7r i.v7Li:7vi
i:irrJ7  :1R        iL:..................7SJMB.    i::.iL    ..iiiii:s  J2.    .7q:YYJr7i r: . : :7:
r:ii:LgL  Pr        2v:................    .i7Z7..rr..:.rr:ir.  :  ..7r:.:PBr      :ij    .i.  vi 7:
r:i:2u:u  5:       :gv::............:.....   ri         .        .         iQqY      .i2:i:::r77rrr:
r:iP5...:Id   .   .dYL7i:.:::.......:ii:... :7   :7:          JP.:    :vr.. sUZI7IDDgEQBBZXjvriirrr:
i.v.   .DBB.     .11irrii:..::.:.:....:iii.:.iiS:. ::.  rY:SBBQBRri.ir:.       vUKu.       .:ri:.::.
*/
#ifndef _USER_TASK_H_
#define _USER_TASK_H_

/*Private Includes*/
#include "stm32H7xx_hal.h"
#include "cmsis_os.h"
#include "stdlib.h"
#include "main.h"
#include "fdcan_bsp.h"
#include "Resolve.h"
#include "semphr.h"
/*Private define*/
//任务序号宏定义
#define drivemode 0
#define grab_pos 1
#define grab_status 2
#define hook_pos 3
#define hook_status 4
#define switcher_pos 5
#define switcher_status 6
#define auto_drive_status 7
#define lock_mode_status 8
#define regulator_L_pos 9
#define regulator_R_pos 10
#define regulator_status 11
#define activator_pos 12
#define activator_status 13
#define delay_status 14
#define deg_offset 15
//操作状态宏定义
#define automode 1
#define manualmode 0
//任务状态宏定义
#define stop 0
#define moving 1
#define moving_complete1 2
#define moving_complete2 3
#define moving_complete3 4
#define moving_partially_complete1 7
#define moving_partially_complete2 8
#define moving_partially_complete3 9
#define moving_error 10
#define moving_place_block 11

//夹具状态
#define release 0
#define grasp 1
//翻转器状态
#define up 0
#define down 2
#define forward 1
#define backward 3
//升降机构位置
#define tower_block_1 2
#define tower_block_2 3
#define tower_block_3 4
#define tower_block_4 5
#define tower_block_5 6
#define tower_bottom 1 
#define tower_bottom2 7
#define tower_block_1_vertical 7
#define tower_block_2_vertical 8
#define tower_block_3_vertical 9
#define tower_block_4_vertical 10
#define to wer_block_5_vertical 11
#define tower_block_1_place 12
#define tower_block_2_place 13
#define tower_block_3_place 14
#define tower_block_4_place 15
#define tower_block_5_place 16

#define delaying 1
#define delay_complete 2
//任务添加序号
#define GRABPOSSET 0
#define AUTODRIVESHORTDISTANCE 1
#define HOOKGRASP 2
#define HOOKRELEASE 3
#define SWITCHERDIRECTIONSET 4
#define CATAPULTACTIVATE 5
#define AUTOPICKUP 6
#define AUTOPLACE 7
#define AUTODRIVELONGDISTANCE 8
#define POSREGULATORPOSSET 9
#define PICKUPACTIVATORPOSSET 10
#define AUTOTURN 11
#define TASKQUEUEDELAY 12
#define MOVEFORWARD 13
#define FUCKBLOCK 14
#define AUTOPICKUPLONG 15
#define MOVEFORWARD2 16

#define either 233
#define total_flags 16 //定义标志位总数量

#define standby 0
#define regulate 1
#define sweep 2
/*Private Typedef*/
typedef struct Ort
{
    float x;
    float y;
    float z;
}Ort;

typedef struct barrier
{
    Ort location;
    float deg;
    double range;
    int barrier_ID;
    int last_update_time;
    struct barrier *next;
}barrier;

typedef struct check_point
{
    Ort pos;
    struct check_point *next;
}check_point;

typedef struct fdcan_msg_queue
{
    FDCAN_HandleTypeDef *fdcan;
    uint8_t msg[8];
    uint32_t ID;
    uint8_t len;
    struct fdcan_msg_queue *next;
}fdcan_msg_queue;

typedef struct mission_queue
{
    int (*taskname)(struct mission_queue*);
    uint8_t request[20];
    uint8_t flag_finish;
    uint8_t flag_necessary;
    short ID;
    Ort info;
    struct mission_queue *next;
    TaskHandle_t *handle;
}mission_queue;

/*Private variables*/
extern int (*autodirveshortdistance)(mission_queue*);
extern int (*autoturn)(mission_queue *current_task);
extern int (*autodrivelongdistance)(mission_queue*);
extern int (*grabposset)(mission_queue*);
extern int (*hookgrasp)(mission_queue*);
extern int (*hookrelease)(mission_queue*);
extern int (*switcherdirectionset)(mission_queue*);
extern int (*catapultactivate)(mission_queue*);
extern int (*autopickup)(mission_queue *current_task);
extern int (*autoplace)(mission_queue *current_task);
extern int (*posregulatorposset)(mission_queue *current_task);
extern int (*pickupactivatorposset)(mission_queue *current_task);
extern int (*taskqueuedelay)(mission_queue *current_task);
extern int (*moveforward)(mission_queue *current_task);
extern int (*fuckblock)(mission_queue *current_task);
extern int (*autopickuplong)(mission_queue *current_task);
extern int (*moveforward2)(mission_queue *current_task);

extern uint8_t flags[20];
extern float dX;
extern float dY;
extern float dZ;
extern FDCAN_HandleTypeDef hfdcan1;
extern FDCAN_HandleTypeDef hfdcan2;
extern UART_HandleTypeDef huart8;
extern UART_HandleTypeDef huart3;
extern uint8_t cmd_feedback[8];
extern Ort target_relative_pos;
extern Ort current_pos;
extern uint8_t rxtemp;
extern PID_T pid_pos;
extern int global_clock;
extern check_point *check_point_head;
extern barrier *barrier_head;
extern uint8_t block_num;
extern int current_target_ID;
extern uint8_t pos_reset;
extern uint8_t thread_lock;
extern uint8_t final_point_lock;
extern void send_log(uint8_t ID,float data1,float data2,float data3,float data4,UART_HandleTypeDef *uart);
extern void send_init_msg(UART_HandleTypeDef *uart,uint8_t ID);
extern uint8_t deg_pid_disable;
extern Ort raw_correction_value;
extern Ort correction_value;
extern void speed_cal(void);
extern void send_log2(float data1,float data2,float data3,float data4,UART_HandleTypeDef *uart);
extern void send_log3(float data1,float data2,float data3,uint8_t id,UART_HandleTypeDef *uart);
extern uint8_t block_color;
extern uint8_t focus_mode;
extern Ort open_loop_velocity;
extern uint8_t communciation_error_counter;
extern short tof_read;
extern fdcan_msg_queue *fdcan_msg_queue_head;
extern SemaphoreHandle_t fdcan_queue_mutex;
extern int judge_sign(double num);
extern Ort r_correction_value;
/*Basic Private Function Prototypes*/
extern void add_mission(int mission_name,uint8_t *request,uint8_t flag_nessary,Ort *info);
int auto_drive_shortdistance(mission_queue *current_task);
int auto_drive_longdistance(mission_queue *current_task);
int grab_pos_set(mission_queue *current_task);
int hook_grasp(mission_queue *current_task);
int hook_release(mission_queue *current_task);
int switcher_direction_set(mission_queue *current_task);
int catapult_activate(mission_queue *current_task);
int auto_pick_up(mission_queue *current_task);
int auto_place(mission_queue *current_task);
int pos_regulator_pos_set(mission_queue *current_task);
int pick_up_activator_pos_set(mission_queue *current_task);
int auto_turn(mission_queue *current_task);
int task_queue_delay(mission_queue *current_task);
int move_forward(mission_queue *current_task);
int fuck_block(mission_queue *current_task);
void fdcan_add_msg_2_queue(FDCAN_HandleTypeDef *hfdcan, uint8_t *TxData, uint32_t StdId, uint32_t Length);
int auto_pick_up_long(mission_queue *current_task);
/*Advanced Private Function Prototypes*/
void pick_up(uint8_t pos,uint8_t mode,uint8_t flag_sensor_mode);
void place_block(uint8_t tower_num);
int move_forward2(mission_queue *current_task);
/*Disposable Private Function Prototypes*/
void send_msg_synchronal(void *id);
#endif
